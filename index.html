<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Shared AR ‚Äî Bulletproof Demo</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover, user-scalable=no" />
  <meta name="theme-color" content="#000000">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">

  <!-- A-Frame + AR.js (marker-based) -->
  <script src="https://aframe.io/releases/1.5.0/aframe.min.js"></script>
  <script src="https://cdn.jsdelivr.net/gh/AR-js-org/AR.js@3.4.3/aframe/build/aframe-ar.js"></script>
  <!-- 3D text (wow factor) -->
  <script src="https://unpkg.com/troika-three-text/dist/troika-three-text.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/aframe-troika-text/dist/aframe-troika-text.min.js"></script>

  <style>
    html, body {
      margin:0; padding:0; height:100dvh; background:#000; overflow:hidden;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, sans-serif;
    }

    /* Status + Debug */
    #scan {
      position:fixed; top:8px; left:8px; z-index:20; background:rgba(0,0,0,.75);
      color:#fff; padding:8px 12px; border-radius:12px; font-size:13px; backdrop-filter:blur(8px);
    }
    #net {
      position:fixed; top:8px; right:8px; z-index:20; background:rgba(0,0,0,.6);
      color:#fff; padding:6px 10px; border-radius:10px; font-size:12px;
    }
    #debug {
      position:fixed; top:48px; left:8px; z-index:20; background:rgba(0,0,0,.6);
      color:#fff; padding:6px 10px; border-radius:10px; font-size:11px; max-width:280px; line-height:1.35;
      white-space:pre-wrap; max-height:150px; overflow-y:auto;
    }

    /* Start button + bottom UI */
    #startAR {
      position: fixed; left: 12px; right: 12px; bottom: 12px; z-index: 30;
      height: 48px; border: none; border-radius: 12px; background: #4ad; color: #002;
      font-weight: 800; font-size: 16px; box-shadow: 0 8px 24px rgba(0,0,0,.35);
    }
    #ui{
      position:fixed; left:0; right:0; bottom:0; z-index:20;
      background:rgba(0,0,0,.6); color:#fff; padding:10px 10px calc(12px + env(safe-area-inset-bottom));
      box-shadow:0 -8px 24px rgba(0,0,0,.25); display:none; backdrop-filter:blur(8px);
    }
    #ui form{ display:grid; grid-template-columns:1fr minmax(70px,110px) auto; gap:8px; align-items:end; }
    #ui label{ display:flex; flex-direction:column; font-size:12px; opacity:.95; }
    #ui input{ height:36px; border-radius:10px; border:1px solid rgba(255,255,255,.25);
      background:rgba(255,255,255,.1); color:#fff; padding:6px 10px; }
    #ui button{ height:36px; border:none; border-radius:10px; background:#4ad; color:#002; font-weight:700; padding:0 16px; }
    #status{ margin-top:6px; font-size:12px; opacity:.85; }

    /* Force camera + canvas to fully cover */
    video, #arjs-video, video#arjs-video, canvas.a-canvas{
      position:fixed !important; inset:0 !important;
      width:100vw !important; height:100vh !important;
      object-fit:cover !important; z-index:0 !important; background:#000 !important;
      display:block !important; visibility:visible !important; opacity:1 !important;
    }
    canvas.a-canvas{ z-index:1 !important; background:transparent !important; }

    .a-enter-vr-button, .a-enter-ar-button, .a-orientation-modal{ display:none !important; }
    *{ -webkit-touch-callout:none; -webkit-user-select:none; user-select:none; -webkit-tap-highlight-color:transparent; }
  </style>
</head>
<body>
  <!-- Status -->
  <div id="scan">üëã Tap ‚ÄúStart AR‚Äù to begin</div>
  <div id="net">üü¢ online</div>
  <div id="debug">waiting‚Ä¶</div>

  <!-- Start -->
  <button id="startAR">Start AR</button>

  <!-- Scene (initialized *after* start to avoid camera conflicts) -->
  <a-scene id="scene" style="display:none"
           embedded vr-mode-ui="enabled:false"
           renderer="alpha:true; colorManagement:true; physicallyCorrectLights:true; antialias:true">
    <a-entity light="type:ambient; intensity:0.8"></a-entity>
    <a-entity light="type:directional; intensity:0.9" position="0.5 1 0.5"></a-entity>

    <!-- Markers -->
    <a-marker id="marker-hiro" preset="hiro" emitevents="true" smooth="true" smoothCount="10" smoothTolerance="0.01" smoothThreshold="5">
      <a-plane class="dropzone" width="6" height="6" rotation="-90 0 0" material="opacity:0; transparent:true"></a-plane>
      <a-box position="0 0.3 0" width="0.6" height="0.6" depth="0.6"
             material="color:#00ff00; opacity:0.9"
             animation="property: rotation; to: 0 360 0; loop: true; dur: 2000"></a-box>
      <a-text value="HIRO marker detected" position="0 0.8 0" align="center" color="#00ff00" scale="0.4 0.4 0.4"></a-text>
    </a-marker>

    <a-marker id="marker-kanji" preset="kanji" emitevents="true" smooth="true" smoothCount="10" smoothTolerance="0.01" smoothThreshold="5">
      <a-plane class="dropzone" width="6" height="6" rotation="-90 0 0" material="opacity:0; transparent:true"></a-plane>
      <a-box position="0 0.3 0" width="0.6" height="0.6" depth="0.6"
             material="color:#ffd166; opacity:0.9"
             animation="property: rotation; to: 360 0 360; loop: true; dur: 2500"></a-box>
      <a-text value="KANJI marker detected" position="0 0.8 0" align="center" color="#ffd166" scale="0.4 0.4 0.4"></a-text>
    </a-marker>

    <!-- click raycaster -->
    <a-entity id="mouse" cursor="rayOrigin: mouse" raycaster="objects: .dropzone; interval: 0"></a-entity>

    <a-entity camera></a-entity>
  </a-scene>

  <!-- Bottom controls -->
  <div id="ui">
    <form id="form">
      <label>Text
        <input id="msg" placeholder="type text‚Ä¶" maxlength="80" />
      </label>
      <label>Scale
        <input id="scale" type="number" step="0.1" value="1.0" inputmode="decimal" />
      </label>
      <button type="submit" id="submit">Pin (local)</button>
    </form>
    <div id="status">No position selected</div>
  </div>

  <script>
    /* ---------- DOM & helpers ---------- */
    const $scan = document.getElementById('scan');
    const $net  = document.getElementById('net');
    const $debug= document.getElementById('debug');
    const scene = document.getElementById('scene');
    const mouse = document.getElementById('mouse');
    const $form = document.getElementById('form');
    const $msg  = document.getElementById('msg');
    const $scale= document.getElementById('scale');
    const $stat = document.getElementById('status');
    const $start= document.getElementById('startAR');

    const setNet = on => $net.textContent = on ? 'üü¢ online' : 'üî¥ offline';
    setNet(navigator.onLine); addEventListener('online',()=>setNet(true)); addEventListener('offline',()=>setNet(false));
    const vibrate = n => { try{ navigator.vibrate && navigator.vibrate(n);}catch{} };
    const setDebug = t => $debug.textContent = t;

    /* ---------- Start AR safely ---------- */
    const ARJS_ATTR = `
      sourceType: webcam;
      videoTexture: false;
      detectionMode: mono;
      sourceWidth: 1280;
      sourceHeight: 720;
      maxDetectionRate: 60;
      debugUIEnabled: false
    `;
    const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent);
    function forceVideoVisible(){
      const vids = document.querySelectorAll('video, #arjs-video, video#arjs-video');
      vids.forEach(v=>{
        v.setAttribute('playsinline','true'); v.setAttribute('webkit-playsinline','true'); v.muted = true;
        Object.assign(v.style,{ position:'fixed', inset:'0', width:'100vw', height:'100vh', objectFit:'cover',
          display:'block', visibility:'visible', opacity:'1', background:'#000' });
      });
      const canvas = document.querySelector('.a-canvas');
      if(canvas){ Object.assign(canvas.style,{position:'fixed', inset:'0', width:'100vw', height:'100vh', background:'transparent', zIndex:'1'}); }
    }

    $start.addEventListener('click', async () => {
      try{
        $scan.textContent = 'Requesting camera‚Ä¶';
        const s = await navigator.mediaDevices.getUserMedia({ video:{ facingMode:'environment' }});
        s.getTracks().forEach(t=>t.stop());
        await new Promise(r=>setTimeout(r,300));

        scene.setAttribute('arjs', ARJS_ATTR);
        scene.style.display = 'block';
        document.getElementById('ui').style.display = 'block';
        $start.style.display = 'none';
        $scan.textContent = 'Scanning markers‚Ä¶';

        [200,800,1500,3000].forEach(t=>setTimeout(forceVideoVisible,t));
        addEventListener('resize', forceVideoVisible);
      }catch(e){
        console.error(e);
        $scan.textContent = '‚ùå Need camera permission';
        alert('Enable camera to use AR.');
      }
    });

    /* ---------- Marker status (events + polling) ---------- */
    const markerState = { hiro:false, kanji:false };
    const hiro  = document.getElementById('marker-hiro');
    const kanji = document.getElementById('marker-kanji');

    const updateScan = ()=>{
      const active = Object.entries(markerState).filter(([,v])=>v).map(([n])=>n.toUpperCase()).join(' / ');
      $scan.textContent = active? `‚úÖ Detected: ${active}` : 'Scanning markers‚Ä¶';
    };
    const onFound = name => { markerState[name]=true; vibrate(15); updateScan(); };
    const onLost  = name => { markerState[name]=false; updateScan(); };
    hiro.addEventListener('markerFound', ()=>onFound('hiro'));
    hiro.addEventListener('markerLost',  ()=>onLost('hiro'));
    kanji.addEventListener('markerFound',()=>onFound('kanji'));
    kanji.addEventListener('markerLost', ()=>onLost('kanji'));

    // Polling helps on some devices
    setInterval(()=>{
      const vis = {
        hiro: !!(hiro.object3D && hiro.object3D.visible),
        kanji:!!(kanji.object3D && kanji.object3D.visible)
      };
      setDebug(`Hiro: ${vis.hiro?'‚úÖ visible':'‚ùå hidden'}\nKanji: ${vis.kanji?'‚úÖ visible':'‚ùå hidden'}`);
    }, 250);

    /* ---------- Local pins (no backend) ---------- */
    const PINS = [
      // Preloaded so the scene looks alive instantly
      { id:'seed1', anchor:'hiro',  pos:[0.10, 0.01, 0.10], text:'Welcome!',     scale:1.2, color:'#90EE90' },
      { id:'seed2', anchor:'hiro',  pos:[-0.15,0.01,-0.05], text:'Scan HIRO',    scale:1.0, color:'#90EE90' },
      { id:'seed3', anchor:'kanji', pos:[0.05, 0.01, 0.00], text:'KANJI ready',  scale:1.1, color:'#FFD166' }
    ];
    const id = ()=> 'p'+Math.random().toString(36).slice(2,8);

    function renderPin(pin){
      const parent = document.getElementById(`marker-${pin.anchor}`); if(!parent) return;
      let el = document.getElementById(`pin-${pin.id}`);
      if(!el){ el=document.createElement('a-entity'); el.id=`pin-${pin.id}`; parent.appendChild(el); }
      const [x,y,z] = pin.pos;
      el.setAttribute('position', `${x} ${y} ${z}`);
      const s = pin.scale || 1;

      // Prefer 3D troika-text, fallback to 2D a-text if unavailable
      if (AFRAME.components['troika-text']) {
        el.removeAttribute('text');
        el.setAttribute('troika-text', `
          value: ${pin.text};
          color: ${pin.color || '#fff'};
          fontSize: 0.20;
          maxWidth: 1.8;
          anchor: center;
          baseline: middle;
          outlineWidth: 0.005;
          outlineColor: black;
          depth: 0.02
        `);
      } else {
        el.removeAttribute('troika-text');
        el.setAttribute('text', `value:${pin.text}; align:center; width:1.8; color:${pin.color||'#fff'}; wrapCount:24`);
      }
      el.setAttribute('scale', `${s} ${s} ${s}`);
    }

    function renderAll(){ PINS.forEach(renderPin); }

    /* ---------- Click to choose a position ---------- */
    let CURRENT = { anchor:null, pos:null };
    const round2 = n => Math.round(n*100)/100;
    const norm = (x,y,z) => [ round2(x), Math.max(round2(y),0)+0.001, round2(z) ];

    function findMarker(el){
      let p = el;
      while(p && p.tagName){ if(p.tagName.toLowerCase()==='a-marker') return p; p=p.parentEl; }
      return null;
    }

    scene.addEventListener('click', ()=>{
      const rc = mouse.components.raycaster;
      if(!rc || !rc.intersections?.length) return;
      const hit = rc.intersections[0];
      if(!hit.object?.el?.classList?.contains('dropzone')) return;
      const marker = findMarker(hit.object.el); if(!marker) return;
      if(!marker.object3D?.visible){ $scan.textContent='‚ö†Ô∏è Marker not visible'; setTimeout(updateScan,1000); return; }

      const anchor = (marker.id==='marker-hiro')?'hiro':'kanji';
      const local  = marker.object3D.worldToLocal(hit.point.clone());
      const pos    = norm(local.x, local.y, local.z);
      CURRENT = { anchor, pos };
      $stat.textContent = `Chosen: ${anchor} (${pos.map(n=>n.toFixed?.(2)||n).join(', ')})`;
      vibrate(25);
    });

    /* ---------- Add new local pin ---------- */
    $form.addEventListener('submit', (e)=>{
      e.preventDefault();
      const msg = ($msg.value||'').trim();
      const sc  = parseFloat($scale.value||'1')||1;
      if(!msg) return alert('Enter text');
      if(!CURRENT.pos) return alert('Tap on the marker area first');

      const color = CURRENT.anchor==='hiro' ? '#90EE90' : '#FFD166';
      const pin = { id:id(), anchor:CURRENT.anchor, pos:CURRENT.pos, text:msg, scale:sc, color };
      PINS.push(pin);
      renderPin(pin);
      $msg.value=''; CURRENT = { anchor:null, pos:null };
      $stat.textContent = 'Pinned locally!';
      vibrate(40);
    });

    /* ---------- Kick it off ---------- */
    renderAll();
    document.addEventListener('visibilitychange', ()=>{ if(!document.hidden) setTimeout(forceVideoVisible, 400); });
  </script>
</body>
</html>
