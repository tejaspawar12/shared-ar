<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Shared AR Pins</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover, user-scalable=no">
  <style>
    html, body {
      margin: 0;
      padding: 0;
      background: #000;
      height: 100%;
      width: 100%;
      overflow: hidden;
    }

    #scan, #net, #ui, #start {
      position: fixed;
      z-index: 20;
      font-family: system-ui, sans-serif;
    }

    #scan {
      top: 8px;
      left: 8px;
      background: rgba(0,0,0,0.6);
      color: #fff;
      padding: 6px 10px;
      border-radius: 10px;
      font-size: 13px;
    }

    #net {
      top: 8px;
      right: 8px;
      background: rgba(0,0,0,0.6);
      color: #fff;
      padding: 6px 10px;
      border-radius: 10px;
      font-size: 12px;
    }

    #start {
      left: 12px;
      right: 12px;
      bottom: 12px;
      height: 48px;
      background: #4ad;
      color: #002;
      font-weight: bold;
      font-size: 16px;
      border: none;
      border-radius: 12px;
      box-shadow: 0 8px 24px rgba(0,0,0,0.35);
    }

    #ui {
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0,0,0,0.6);
      color: #fff;
      padding: 10px;
      display: none;
    }

    #ui form {
      display: flex;
      gap: 10px;
    }

    #ui input, #ui button {
      height: 36px;
      border-radius: 8px;
      padding: 0 10px;
    }

    #msg {
      flex-grow: 1;
      background: rgba(255,255,255,0.1);
      border: 1px solid rgba(255,255,255,0.25);
      color: white;
    }

    #scale {
      width: 60px;
      background: rgba(255,255,255,0.1);
      border: 1px solid rgba(255,255,255,0.25);
      color: white;
    }

    #submit {
      background: #4ad;
      color: #002;
      font-weight: bold;
      border: none;
    }

    a-scene {
      position: fixed;
      top: 0;
      left: 0;
      width: 100vw;
      height: 100vh;
    }

    .a-enter-vr-button, .a-enter-ar-button, .a-orientation-modal {
      display: none !important;
    }
  </style>

  <!-- A-Frame + AR.js -->
  <script src="https://aframe.io/releases/1.5.0/aframe.min.js"></script>
  <script src="https://cdn.jsdelivr.net/gh/AR-js-org/AR.js@3.4.3/aframe/build/aframe-ar.min.js"></script>
  <script src="https://unpkg.com/troika-three-text/dist/troika-three-text.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/aframe-troika-text/dist/aframe-troika-text.min.js"></script>

  <!-- Firebase -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-app.js";
    import { getFirestore, collection, addDoc, onSnapshot, orderBy, query, serverTimestamp }
      from "https://www.gstatic.com/firebasejs/12.1.0/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyBYsPxSPvpv8mPQdVGJuzE2TKZ0qY6e608",
      authDomain: "ar-maker-share.firebaseapp.com",
      projectId: "ar-maker-share",
      storageBucket: "ar-maker-share.appspot.com",
      messagingSenderId: "68968164615",
      appId: "1:68968164615:web:c56d3c17046ff51ebf29a2"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const pins = collection(db, "pins");

    const scene = document.querySelector('a-scene');
    const startBtn = document.getElementById('start');
    const scanText = document.getElementById('scan');
    const ui = document.getElementById('ui');
    const form = document.getElementById('form');
    const msgInput = document.getElementById('msg');
    const scaleInput = document.getElementById('scale');

    const USER_ID = 'user_' + Math.random().toString(36).substring(2, 8);

    let CURRENT = { anchor: null, pos: null };

    startBtn.onclick = () => {
      scene.setAttribute('arjs', 'sourceType: webcam; detectionMode: mono;');
      scene.style.display = 'block';
      ui.style.display = 'block';
      startBtn.style.display = 'none';
    };

    document.getElementById('marker-hiro').addEventListener('click', e => {
      const pos = e.detail.intersection.point;
      CURRENT = { anchor: 'hiro', pos: [pos.x, pos.y, pos.z] };
    });

    form.addEventListener('submit', async (e) => {
      e.preventDefault();
      const text = msgInput.value.trim();
      const scale = parseFloat(scaleInput.value || '1.0');
      if (!text || !CURRENT.pos) return;

      await addDoc(pins, {
        anchor: CURRENT.anchor,
        pos: CURRENT.pos,
        text,
        scale,
        userId: USER_ID,
        mode: "arjs",
        ts: serverTimestamp()
      });

      msgInput.value = '';
    });

    onSnapshot(query(pins, orderBy("ts", "asc")), snap => {
      snap.docChanges().forEach(change => {
        const data = change.doc.data();
        if (data.mode !== 'arjs') return;
        const anchorId = data.anchor === 'kanji' ? 'marker-kanji' : 'marker-hiro';
        const marker = document.getElementById(anchorId);
        if (!marker) return;

        let pin = document.getElementById(`pin-${change.doc.id}`);
        if (!pin) {
          pin = document.createElement('a-entity');
          pin.setAttribute('id', `pin-${change.doc.id}`);
          marker.appendChild(pin);
        }

        pin.setAttribute('position', data.pos.join(' '));
        pin.setAttribute('troika-text', `value: ${data.text}; color: ${data.userId === USER_ID ? '#00ff00' : '#ccc'}; fontSize: 0.3`);
        pin.setAttribute('scale', `${data.scale} ${data.scale} ${data.scale}`);
      });
    });
  </script>
</head>
<body>
  <div id="scan">Tap ‚ÄúStart AR‚Äù to begin</div>
  <div id="net">üü¢ online</div>
  <button id="start">Start AR</button>
  <div id="ui">
    <form id="form">
      <input id="msg" placeholder="type text‚Ä¶" maxlength="80" />
      <input id="scale" type="number" step="0.1" value="1.0" />
      <button type="submit" id="submit">Pin</button>
    </form>
  </div>

  <a-scene embedded vr-mode-ui="enabled: false" renderer="antialias: true; alpha: true">
    <a-marker id="marker-hiro" preset="hiro" emitevents="true" smooth="true">
      <a-plane width="6" height="6" rotation="-90 0 0" material="opacity: 0.0;"></a-plane>
    </a-marker>

    <a-marker id="marker-kanji" preset="kanji" emitevents="true" smooth="true">
      <a-plane width="6" height="6" rotation="-90 0 0" material="opacity: 0.0;"></a-plane>
    </a-marker>

    <a-entity camera></a-entity>
  </a-scene>
</body>
</html>
